/*! updated; 02-13-2018 04:14 PM **/


Modulr.define("core.auth:api",["require","jquery"],function(require,$){var INITIALIZED=!1;return new function(){var Proto=this;Proto.init=function(){INITIALIZED||(INITIALIZED=!0,require(["modules/navbar"]))},Proto.initLegacy=function(){INITIALIZED||(INITIALIZED=!0,require(["modules/navbar.legacy"]))},Proto.middleware=function(callback){"function"==typeof callback&&require(["models/middleware"],function(Middleware){callback(Middleware)})}}});
Modulr.define("core.auth:config",["require","jquery","cdn"],function(require,$){var CDN=require("cdn"),env=(CDN.domain,CDN.env),protocol=["htt","ps:"].join(""),config={};return config.hostname=function(){var hostname;switch(env){case"qa":hostname="aem-dev-publisher.foxnews.com";break;case"staging":hostname="foxnews.com";break;default:hostname="foxnews.com"}return hostname}(),config.auth0jslocation=protocol+"//cdn.auth0.com/js/auth0/8.9.2/auth0.min.js",config.profileApiUrl=function(){var res;switch(env){case"qa":res=protocol+"//foxnews-dev.us.webtask.io/userprofile";break;case"staging":res=protocol+"//foxnews.us.webtask.io/userprofile";break;default:res=protocol+"//foxnews.us.webtask.io/userprofile"}return res}(),config.profilePage=protocol+("qa"===env?"//dev.static.":"//www.")+"foxnews.com/community/auth/user/profile.html",config.cdn=CDN,config});
Modulr.define("core.auth:helper",["require","jquery"],function(require,$){var Helper=function(){};return Helper.prototype.log=function(){if(window.console){var args=Array.prototype.slice.call(arguments);args.unshift("[core.auth]");try{return window.console.log.apply(window.console,args)}catch(err){window.console.log(args.join(" | "))}}},new Helper});
Modulr.define("core.auth:index",["require","jquery"],function(require,$){return require});
Modulr.define("core.auth:models/callback",["require","jquery","lodash","config","options"],function(require,$,_,config){return function(FNNAuth){console.log("callback file"),console.log(FNNAuth),document.querySelector("#resend_verification").addEventListener("click",function(e){e.preventDefault(),setTimeout(function(){swal.showLoading(),FNNAuth.callProfileApi("POST",{action:"verify_email"},function(err){if(swal.close(),err)return void console.log(err)})},500)})}});
Modulr.define("core.auth:models/fnnauth.broker",["require","jquery","cdn"],function(require,$,CDN){var iframe,root=window,env=CDN.env,domain="qa"===env?"//dev.static.foxnews.com":"//www.foxnews.com",ready=!1,callbacks={},ssl=["htt","ps:"].join(""),origin=ssl+domain,queue=[],iframeLink=origin+"/community/auth/user/iframe.html?",addCallback=function(name,cb){callbacks[name]=callbacks[name]||[],callbacks[name].push(cb)},sendMessage=function(name,data){var message={name:name,data:data,type:"fnnBrokerRequest"};ready?iframe.contentWindow.postMessage(message,origin):queue.push(message)},dispatch=function(event){if(event.origin===origin&&"fnnBrokerResponse"===event.data.type)if("ready"===event.data.name)for(ready=!0;queue.length>0;)iframe.contentWindow.postMessage(queue.shift(),origin);else{var cbs=callbacks[event.data.name]||[];for(callbacks[event.data.name]=[];cbs.length>0;)cbs.shift()(event.data.data)}},startLogin=function(){addCallback("startLogin",function(url){window.location.href=url}),sendMessage("startLogin",window.location.href)},startLogout=function(callback){callback&&addCallback("startLogout",callback),sendMessage("startLogout",null)},initialize=function(callback){callback({startLogin:startLogin,startLogout:startLogout})},FNNAuth=function(domainName){var refreshProfile=-1!==window.location.search.indexOf("refresh_profile_info=on");iframe=document.createElement("iframe"),iframe.style.display="none",iframe.src=iframeLink+(refreshProfile?"refresh_profile_info=on&":"")+"origin="+encodeURIComponent(root.location.origin)+"&domain="+encodeURIComponent(domainName),document.body.appendChild(iframe),root.addEventListener("message",dispatch)};return FNNAuth.prototype.initialize=initialize,FNNAuth.prototype.MODE_silentLogin=function(callback){addCallback("silentLogin",callback),sendMessage("silentLogin",null)},FNNAuth});
Modulr.define("core.auth:models/fnnauth",["require","jquery","lodash","config","options","models/script.loader","models/spot.im","cdn"],function(require,$,_,config){function setupBirthdaySelects(){function validate_date(){var y=+kcyear.value,m=kcmonth.value,d=kcday.value;""===m&&""===d&&(y="");d<=9&&(d="0"+d),m<=9&&(m="0"+m),y<1950&&(y=""),"02"===m&&d>28?d="":("04"===m&&d>30||"09"===m&&d>30||"11"===m&&d>30)&&(d=""),kcbirthday.value=[y,m,d].join("-")}function call(){if(!yearSelectInitialized){for(var d=new Date,n=d.getFullYear()-13,i=n;i>=1950;i--){var opt=new Option;opt.value=opt.text=i,kcyear.add(opt)}yearSelectInitialized=!0}validate_date()}var kcyear=document.getElementsByName("year")[0],kcmonth=document.getElementsByName("month")[0],kcday=document.getElementsByName("day")[0],kcbirthday=document.getElementsByName("birthday")[0],yearSelectInitialized=!1;if(kcyear.onchange=kcmonth.onchange=kcday.onchange=call,kcyear.addEventListener("change",validate_date),kcday.addEventListener("change",validate_date),kcmonth.addEventListener("change",validate_date),kcbirthday.value){var existingDate=function(date){return new Date(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds())}(new Date(kcbirthday.value));if(isIE){var evtIE=document.createEvent("HTMLEvents");evtIE.initEvent("change",!1,!0),kcmonth.value=String(existingDate.getMonth()+1),kcmonth.dispatchEvent(evtIE),kcday.value=String(existingDate.getDate()),kcday.dispatchEvent(evtIE),kcyear.value=String(existingDate.getFullYear()),kcyear.dispatchEvent(evtIE)}else kcmonth.value=String(existingDate.getMonth()+1),kcmonth.dispatchEvent(new Event("change")),kcday.value=String(existingDate.getDate()),kcday.dispatchEvent(new Event("change")),kcyear.value=String(existingDate.getFullYear()),kcyear.dispatchEvent(new Event("change"))}}var domain,redirect,webAuth,options,editPhotoBtn,root=window,DOMAIN_OPTIONS=require("options"),ScriptLoader=require("models/script.loader"),ssl=["htt","ps:"].join(""),http=["htt","p:"].join(""),SpotIM=require("models/spot.im"),storage=root.sessionStorage,document=root.document,auth0jslocation=config.auth0jslocation,profileApiUrl=config.profileApiUrl,errorEl=document.querySelector(".message-error"),errorElText=document.querySelector(".message-error > span"),successEl=document.querySelector(".message-success"),profileEditor=document.querySelector(".fn-user-profile"),profileOptionalFields=document.querySelector(".auth0-optional"),DEFAULT_PROFILE_PICTURE=ssl+"//global.fncstatic.com/static/orion/styles/img/fox-news/auth0/auth0-default-profile-pic.png",FOX_LOGO_URL="//global.fncstatic.com/static/orion/styles/img/fox-news/s/logos/fox-news-logo-small.svg",CDN=(-1!==navigator.userAgent.indexOf("Safari")&&navigator.userAgent.indexOf("Chrome"),require("cdn")),env=CDN.env,connectionName="qa"===env?"user-data-migration":"Username-Password-Authentication-2",isIE=-1!==navigator.userAgent.indexOf("MSIE")||window.navigator.appVersion.indexOf("Trident/")>0,scrollTo=function(elm){$("html, body").animate({scrollTop:$(elm).offset().top-60},300)},showError=function(err,fn,options){if(hideSuccess(),errorEl&&!fn)errorEl.style.display="block",errorElText.textContent=err.message||err,scrollTo(errorEl);else{var cancelAction=options.cancelAction;"function"==typeof cancelAction&&(options.showCancelButton=!0,delete options.cancelAction);var prom=swal(Object.assign({type:"error",title:"Uh Oh",text:err.message||err,customClass:"swal-error"},options));fn&&prom.then(fn),cancelAction?prom.catch(function(dismiss){"string"==typeof dismiss&&cancelAction()}):prom.catch(swal.noop)}return err},hideError=function(){errorEl&&(errorEl.style.display="none",errorElText.textContent=""),swal.close()},showSuccess=function(msg,title,swalOpts){if(hideError(),!successEl||swalOpts){var cancelAction=swalOpts.cancelAction;"function"==typeof cancelAction&&(swalOpts.showCancelButton=!0,delete swalOpts.cancelAction);var prom=swal(Object.assign({type:"success",title:title,text:msg,customClass:"swal-success",imageUrl:FOX_LOGO_URL},swalOpts));return cancelAction?prom.catch(function(dismiss){"string"==typeof dismiss&&cancelAction()}):prom.catch(swal.noop),prom}successEl.style.display="block",successEl.querySelector("span").textContent=msg,scrollTo(successEl)},hideSuccess=function(err){successEl&&(successEl.style.display="none",successEl.querySelector("span").textContent=""),swal.close()},setAuthAttributeInBody=function(){document.body.setAttribute("data-auth",isAuthenticated().toString())},callProfileApi=function(method,body,callback){if(void 0===callback&&(callback=body,body=void 0),!isAuthenticated())return callback(new Error("The user has to login to set the profile"));silentLogin(setResult(function(err,authResult){if(!isAuthenticated())return callback(new Error("The user has to login to set the profile"));var req=new XMLHttpRequest;req.open(method,profileApiUrl),req.setRequestHeader("Authorization","Bearer "+retrieveAccessToken()),req.setRequestHeader("Content-type","application/json"),req.onreadystatechange=function(){if(4===req.readyState){if(req.status>=400){var err=req.responseText;try{err=JSON.parse(err),err=err.message||err.error}catch(e){}return callback(new Error(err))}callback(null,req.responseText&&JSON.parse(req.responseText))}};try{req.send(body&&JSON.stringify(body))}catch(e){callback(e)}}))},getDomainOptions=function(domain){return options||(options=DOMAIN_OPTIONS[domain]),options},loadJs=function(src,callback){ScriptLoader(src,callback)},store=function(key,value){void 0!==value?storage.setItem(key,JSON.stringify(value)):storage.removeItem(key)},retrieve=function(key){return JSON.parse(storage.getItem(key))},storeAccessToken=store.bind(null,"fnnauth:accessToken"),storeProfile=store.bind(null,"fnnauth:profile"),storeTargetUrl=store.bind(null,"fnnauth:targetUrl"),retrieveAccessToken=retrieve.bind(null,"fnnauth:accessToken"),retrieveProfile=retrieve.bind(null,"fnnauth:profile"),retrieveTargetUrl=retrieve.bind(null,"fnnauth:targetUrl"),setResult=function(callback,updateProfile){return function(err,authResult){storeAccessToken(authResult&&authResult.accessToken),updateProfile&&storeProfile(authResult&&authResult.idTokenPayload),callback(err,authResult)}},createLink=function(text,className,callback){var link=document.createElement("a");return link.className=className,link.innerHTML=text,link.addEventListener?link.addEventListener("click",callback):link.attachEvent("onclick",callback),link},changePassword=function(e){e.preventDefault(),swal({title:"Reset Password",text:"Are you sure you would like to send a password reset email?",type:"question",showCloseButton:!0,customClass:"swal-success",imageUrl:FOX_LOGO_URL,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Send Reset Email"}).then(function(){swal.showLoading(),getWebAuth(function(webAuth){getUserProfile(function(err,profile){if(err)return err.message=err.message||err.description,showError(err.message);webAuth.changePassword({connection:connectionName,email:profile.email},function(err,resp){return err?(err.message=err.description,showError(err)):showSuccess("An email has been sent to your inbox.")})})})}).catch(swal.noop)},deleteUserProfileApi=function(callback){callProfileApi("DELETE",callback)},deleteAccount=function(e){e.preventDefault(),swal({title:"Delete Account",text:"Are you sure you want to permanently delete your Fox News Digital account? You will lose your activity history and email preferences.",type:"question",showCloseButton:!0,customClass:"swal-error",imageUrl:FOX_LOGO_URL,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Delete Account"}).then(function(){setTimeout(function(){swal.showLoading(),getUserProfile(function(err,profile){if(err)return err.message=err.message||err.description,showErr(err);deleteUserProfileApi(function(err){err?(err.message=err.description,swal({type:"error",title:"uh oh",text:err.message})):(showSuccess("Account deleted."),startLogout())})})},1e3)}).catch(swal.noop)},profileHandlers=function(profile){var changePassModal=document.getElementById("change-pass"),deleteAccountModal=document.getElementById("delete-account");changePassModal&&changePassModal.addEventListener("click",changePassword),deleteAccountModal&&(isIE?$("#delete-account").addClass("hide"):deleteAccountModal.addEventListener("click",deleteAccount))},renderProfileFields=function(profile){for(var elements=document.querySelectorAll("[data-user-field]"),i=elements.length-1;i>=0;i--){var el=elements[i],field=el.getAttribute("data-user-field"),value=profile[field]||profile[ssl+"//foxnews.com/"+field];"IMG"===el.tagName?el.setAttribute("src",value):el.textContent=value}},_metadata={},saveProfileMetadata=function(cb){var metadata=_metadata;metadata.first_name=profileEditor.querySelector("[name='first_name']").value,metadata.birthday=profileEditor.querySelector("[name='birthday']").value||"",metadata.last_name=profileEditor.querySelector("[name='last_name']").value,metadata.display_name=profileEditor.querySelector("[name='display_name']").value,metadata.political_views=profileEditor.querySelector("[name='political_views']").value,metadata.household_income=profileEditor.querySelector("[name='household_income']").value,metadata.gender=profileEditor.querySelector("[name='gender']").value,metadata.zip_code=profileEditor.querySelector("[name='zip_code']").value||"",metadata.account_active="true",metadata.picture!==DEFAULT_PROFILE_PICTURE&&(metadata.picture=profileEditor.querySelector("[name='profile_picture']").getAttribute("src")||""),metadata.newsletters={fb_breaking_alerts:profileEditor.querySelector("[name='fb_breaking_alerts']").checked,fn_breaking_alerts:profileEditor.querySelector("[name='fn_breaking_alerts']").checked,fn_morn_headlines:profileEditor.querySelector("[name='fn_morn_headlines']").checked,top_headline:profileEditor.querySelector("[name='top_headline']").checked,fn_opinion_headlines:profileEditor.querySelector("[name='fn_opinion_headlines']").checked,fn_fox_411_newsletter:profileEditor.querySelector("[name='fn_fox_411_newsletter']").checked,fn_science_and_technology:profileEditor.querySelector("[name='fn_science_and_technology']").checked,fn_health_newsletter:profileEditor.querySelector("[name='fn_health_newsletter']").checked,fox_fan_scoop:profileEditor.querySelector("[name='fox_fan_scoop']").checked,halftime_report:profileEditor.querySelector("[name='halftime_report']").checked},swal.showLoading(),setUserMetadata(metadata,function(err){if(cb&&setTimeout(function(){cb(err)},100),err)return showError(err);showSuccess("You have successfully updated your settings.")})},saveOptionalMetadata=function(cb){var metadata=_metadata;metadata.political_views=profileOptionalFields.querySelector("[name='political_views']").value,metadata.household_income=profileOptionalFields.querySelector("[name='household_income']").value,metadata.account_active="true",metadata.newsletters={fn_breaking_alerts:profileOptionalFields.querySelector("[name='fn_breaking_alerts']").checked,fn_morn_headlines:profileOptionalFields.querySelector("[name='fn_morn_headlines']").checked,top_headline:profileOptionalFields.querySelector("[name='top_headline']").checked,halftime_report:profileOptionalFields.querySelector("[name='halftime_report']").checked},swal.showLoading(),setUserMetadata(metadata,function(err){if(cb&&setTimeout(function(){cb(err)},100),err)return showError(err);location.href="qa"===env?http+"//hp.dev-cms.foxnews.com/":http+"//foxnews.com/"}),profileEditor.classList.remove("hide"),profileOptionalFields.classList.add("hide")},skipOptionalMetadata=function(cb){var metadata=_metadata;metadata.account_active="true",swal.showLoading(),setUserMetadata(metadata,function(err){if(cb&&setTimeout(function(){cb(err)},100),err)return showError(err);location.href="qa"===env?http+"//hp.dev-cms.foxnews.com":http+"//foxnews.com/"}),profileEditor.classList.remove("hide"),profileOptionalFields.classList.add("hide")},checkIfEmailVerified=function(profile){profile=profile||{};var profileContent=$(".auth0-profile-content"),authVerify=document.getElementById("auth0-verify");if(!profile.email_verified)return authVerify&&authVerify.classList.remove("hide"),profileContent.addClass("hide"),profile[ssl+"//foxnews.com/logins_count"]>1&&resendVerificationEmail(),void setTimeout(function(){startCallbackLogout()},1e3);profileContent.removeClass("hide")},resendVerificationEmail=function(){setTimeout(function(){swal.showLoading(),callProfileApi("POST",{action:"verify_email"},function(err){if(swal.close(),err)return void console.log(err)})},500)},checkIfAccountActive=function(profile){if(profile&&"false"===profile[ssl+"//foxnews.com/metadata"].account_active)return void(profileOptionalFields&&(profileEditor.classList.add("hide"),profileOptionalFields.classList.remove("hide")));profile&&"false"!==profile[ssl+"//foxnews.com/metadata"].account_active&&profileOptionalFields&&(profileEditor.classList.remove("hide"),profileOptionalFields.classList.add("hide"))},setupProfileEditor=function(profile){_metadata=profile[ssl+"//foxnews.com/metadata"]||{};var metadata=_metadata;checkIfEmailVerified(profile),checkIfAccountActive(profile),metadata.picture===DEFAULT_PROFILE_PICTURE&&editPhotoBtn&&(editPhotoBtn.style.display="none"),Object.keys(metadata).forEach(function(key){["true","false"].includes(metadata[key])&&(metadata[key]="true"===metadata[key])});var newsletters=metadata.newsletters||{};profileEditor.querySelector("[name='email']").value=profile.email,profileEditor.querySelector("[name='birthday']").value=metadata.birthday,profileEditor.querySelector("[name='first_name']").value=metadata.first_name,profileEditor.querySelector("[name='last_name']").value=metadata.last_name,profileEditor.querySelector("[name='display_name']").value=metadata.display_name,profileEditor.querySelector("[name='zip_code']").value=metadata.zip_code||"",profileEditor.querySelector("[name='political_views']").value=metadata.political_views,profileEditor.querySelector("[name='household_income']").value=metadata.household_income,profileEditor.querySelector("[name='gender']").value=metadata.gender,profileEditor.querySelector("[name='fb_breaking_alerts']").checked=newsletters.fb_breaking_alerts,profileEditor.querySelector("[name='fn_breaking_alerts']").checked=newsletters.fn_breaking_alerts,profileEditor.querySelector("[name='fn_morn_headlines']").checked=newsletters.fn_morn_headlines,profileEditor.querySelector("[name='top_headline']").checked=newsletters.top_headline,profileEditor.querySelector("[name='fn_opinion_headlines']").checked=newsletters.fn_opinion_headlines,profileEditor.querySelector("[name='fn_fox_411_newsletter']").checked=newsletters.fn_fox_411_newsletter,profileEditor.querySelector("[name='fn_science_and_technology']").checked=newsletters.fn_science_and_technology,profileEditor.querySelector("[name='fn_health_newsletter']").checked=newsletters.fn_health_newsletter,profileEditor.querySelector("[name='fox_fan_scoop']").checked=newsletters.fox_fan_scoop,profileEditor.querySelector("[name='halftime_report']").checked=newsletters.halftime_report,profile[ssl+"//foxnews.com/is_social"]||document.querySelector(".auth0-group-password").classList.remove("hide"),profileOptionalFields.querySelector("[name='political_views']").value=metadata.political_views,profileOptionalFields.querySelector("[name='household_income']").value=metadata.household_income,profileOptionalFields.querySelector("[name='halftime_report']").checked=newsletters.halftime_report,profileOptionalFields.querySelector("[name='fn_breaking_alerts']").checked=newsletters.fn_breaking_alerts,profileOptionalFields.querySelector("[name='fn_morn_headlines']").checked=newsletters.fn_morn_headlines,profileOptionalFields.querySelector("[name='top_headline']").checked=newsletters.top_headline,setupBirthdaySelects(),document.querySelector("#save-profile").addEventListener("click",function(e){e.preventDefault(),saveProfileMetadata()}),document.querySelector("#submit_optional_fields").addEventListener("click",function(e){e.preventDefault(),saveOptionalMetadata()}),document.querySelector("#skip_optional_fields").addEventListener("click",function(e){e.preventDefault(),skipOptionalMetadata()})},renderUserInfo=function(){SpotIM.send("hello",function(fromSpot){console.log("im back from spot.im with this>>",fromSpot)}),getUserProfile(function(err,profile){if(err)return void console.error("Error retrieving the user profile",err);profileHandlers(),renderProfileFields(profile),setupProfileEditor(profile)})},createWebAuth=function(){return webAuth=webAuth||new auth0.WebAuth(options.default)},loadAuth0js=function(){function ready(){if(LOAD_STACK.length>0)for(;LOAD_STACK.length>0;){var fn=LOAD_STACK.shift();fn(createWebAuth())}}var LOAD_INITIALIZED=!1,LOAD_STACK=[];return function(callback){root.auth0?callback(createWebAuth()):(LOAD_STACK.push(callback),LOAD_INITIALIZED||(LOAD_INITIALIZED=!0,loadJs(auth0jslocation,function(){ready()})))}}(),getWebAuth=function(callback){loadAuth0js(function(){webAuth=webAuth||new root.auth0.WebAuth(options.default),callback(webAuth)})},silentLogin=function(callback){getWebAuth(function(webAuth){webAuth.renewAuth(options.silent,setResult(callback))})},auth0Logout=window.auth0logout=function(cb){getWebAuth(function(webAuth){var iframe=document.createElement("iframe");iframe.style.display="none",iframe.src=webAuth.client.buildLogoutUrl(),iframe.onload=iframe.onerror=cb,document.body.appendChild(iframe)})},startLogout=function(e){"object"==typeof e&&e.preventDefault(),storeAccessToken(),storeProfile(),swal.showLoading(),auth0Logout(function(){if("function"==typeof e)e();else{var lastPageVisited=document.referrer;lastPageVisited.indexOf("callback")>-1?location.href=http+"//foxnews.com":lastPageVisited.indexOf("fox")>-1?location.href=lastPageVisited:location.href=http+"//foxnews.com"}})},startLogin=function(e){e&&e.preventDefault(),storeTargetUrl(window.location.href),getWebAuth(function(webAuth){webAuth.authorize(options.authorize)})},startIframeLogin=function(url,callback){var optionsLogin=webAuth.transactionManager.process(_.merge({},options.default,options.authorize));optionsLogin=_.omit(optionsLogin,["domain","root_url","overrides","tenant","token_issuer"]),store("auth0.state."+optionsLogin.state,optionsLogin.nonce),storeTargetUrl(url),getWebAuth(function(webAuth){callback(webAuth.client.buildAuthorizeUrl(optionsLogin))})},startIframeLogout=function(cb){return storeAccessToken(),storeProfile(),auth0Logout(function(){cb()}),!1},startCallbackLogout=function(e){"object"==typeof e&&e.preventDefault(),storeAccessToken(),storeProfile(),auth0Logout(function(){"function"==typeof e&&e()})},authnCallback=function(err,authResult){!err&&authResult&&authResult.accessToken?(console.log("Login completed successfully"),renderUserInfo()):console.log("Unsuccessful attempt to login",err,authResult),setAuthAttributeInBody()},getUserProfile=function(callback,useSilentLogin){if(!isAuthenticated())return callback(new Error("The user has to login to get the profile"));useSilentLogin=!1!==useSilentLogin;var profile=retrieveProfile(),clearProfileCache=-1!==location.search.indexOf("refresh_profile_info=on");if(profile&&!clearProfileCache)return callback(null,profile);var token=retrieveAccessToken();getWebAuth(function(webAuth){webAuth.client.userInfo(token,function(err,user){if(err){if(!useSilentLogin)return callback(err);silentLogin(getUserProfile.bind(null,callback,!1))}storeProfile(user),callback(null,user)})})},setUserProfile=window.setUserProfile=function(profile,callback){callProfileApi("PATCH",profile,function(err,data){if(err)return callback(err);silentLogin(setResult(function(){getUserProfile(callback)},!0))})},setUserMetadata=function(profile,callback){var auth0Authenticate=$("#auth0-authenticate");if(!isAuthenticated())return auth0Authenticate&&auth0Authenticate.removeClass("hide"),callback(new Error("The user has to login to set the profile"));setUserProfile({user_metadata:profile},callback)},isAuthenticated=function(){return!!retrieveAccessToken()},login=function(callback){isAuthenticated()?getUserProfile(callback):silentLogin(function(err,authResult){if(err)return callback(err);isAuthenticated()?getUserProfile(callback,!1):startLogin()})},initialize=function(){var args=arguments;if("function"==typeof args[0]){var events={startLogin:startLogin,startLogout:startLogout};args[0](events)}else initialize_AUTHZERO.call(initialize_AUTHZERO,arguments)},initialize_AUTHZERO=function(profileElSel,loginElSel){profileElement=document.getElementById(profileElSel),loginElement=document.getElementById(loginElSel);var loginBtn=document.querySelector("a.login"),logoutBtn=document.querySelector(".auth0-btn-logout"),changePassEl=document.getElementById("change-pass");loginBtn?loginBtn.onclick=startLogin:loginElement.appendChild(createLink("Login","fnnauth0-login",startLogin)),logoutBtn?logoutBtn.onclick=startLogout:changePassEl&&changePassEl.parentElement.insertBefore(createLink("Log Out","fnnauth0-logout",startLogout),document.getElementById("change-pass")),editPhotoBtn=document.querySelector(".auth0-edit-photo > a"),editPhotoBtn&&(editPhotoBtn.onclick=function(e){swal({title:"Remove Photo",text:"Are you sure you want to remove this photo? You will not be able to upload a new image.",type:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Remove photo",cancelButtonText:"No, cancel!",imageUrl:FOX_LOGO_URL,customClass:"swal-error"}).then(function(){_metadata.picture=DEFAULT_PROFILE_PICTURE,saveProfileMetadata(function(err){err||location.reload()})}).catch(swal.noop),e.preventDefault()}),setAuthAttributeInBody(),isAuthenticated()?renderUserInfo():silentLogin(authnCallback)},FNNAuth=function(domainName,useRedirect){domain=domainName||root.location.hostname,redirect=!1!==useRedirect,options=getDomainOptions(domain)};FNNAuth.prototype.initialize=initialize,FNNAuth.prototype.login=login,FNNAuth.prototype.startIframeLogin=startIframeLogin,FNNAuth.prototype.isAuthenticated=isAuthenticated,FNNAuth.prototype.getUserProfile=getUserProfile,FNNAuth.prototype.setUserMetadata=setUserMetadata,FNNAuth.prototype.startIframeLogout=startIframeLogout,FNNAuth.prototype.showError=showError,FNNAuth.prototype.hideError=hideError,FNNAuth.prototype.showSuccess=showSuccess,FNNAuth.prototype.hideSuccess=hideSuccess,FNNAuth.prototype.callProfileApi=callProfileApi,FNNAuth.prototype.startLogout=startLogout,FNNAuth.prototype.MODE_silentLogin=function(callback){function done(isAuth,userInfo){callback({authenticated:isAuth,token:retrieveAccessToken(),userInfo:userInfo})}if(isAuthenticated())return callback({authenticated:!0,token:retrieveAccessToken()});silentLogin(function(err,authResult){err||authResult||console.warn("Authentication cancelled");var isAuth=isAuthenticated();isAuth?getUserProfile(function(userInfo){done(isAuth,userInfo)}):done(isAuth,null)})};var staticInitialize=function(profileElement,loginElement,domain,redirect){new FNNAuth(domain,redirect).initialize(profileElement,loginElement)},handleCallback=function(domain){options=getDomainOptions(domain||root.location.hostname),getWebAuth(function(webAuth){var optionsParse={},index=(window.location.hash||"").indexOf("state=");if(index>=0){var state=window.location.hash.substr(index+6).split("&").shift();optionsParse.nonce=retrieve("auth0.state."+state),store("auth0.state."+state)}webAuth.parseHash(optionsParse,setResult(function(err,authResult){var redirectUser=function(profile){var redirect=retrieveTargetUrl()||root.location.origin;storeTargetUrl();root.opener;if(profile&&!profile.email_verified)return void startCallbackLogout();checkIfAccountActive(profile),function(profile){profile&&"false"===profile[ssl+"//foxnews.com/metadata"].account_active&&root.location.href!==config.profilePage?root.location.href=config.profilePage:-1!==redirect.indexOf("community/auth/user/login.html")&&"false"!==profile[ssl+"//foxnews.com/metadata"].account_active||-1!==redirect.indexOf("community/auth/user/login-password.html")&&"false"!==profile[ssl+"//foxnews.com/metadata"].account_active||-1!==redirect.indexOf("community/auth/user/login-unblocked.html")&&"false"!==profile[ssl+"//foxnews.com/metadata"].account_active||-1!==redirect.indexOf("community/auth/user/login-general.html")&&"false"!==profile[ssl+"//foxnews.com/metadata"].account_active?root.location.href=http+"//www.foxnews.com/":redirect===ssl+"//dev.static.foxnews.com"?root.location.href=config.profilePage:root.location.href=redirect}(profile)};if(err)return console.log(err),redirectUser();getUserProfile(function(err,profile){if(profile=profile||{},checkIfEmailVerified(profile),profile.email_verified)return profile.email_verified&&checkIfAccountActive(profile),redirectUser(profile)})}))})};return FNNAuth.initialize=staticInitialize,FNNAuth.handleCallback=handleCallback,FNNAuth});
Modulr.define("core.auth:models/middleware",["require","jquery","config","helper","models/fnnauth.broker"],function(require,$,config,Helper){var Authentication=require("models/fnnauth.broker"),Auth=new Authentication(config.hostname);return new function(){var Proto=this,_props=null,_events=null,spotim_notifier=null;Proto.getProps=function(){return _props},Proto.getEvents=function(){return _events},Proto.onLogin=function(cb){if(!cb&&"function"!=typeof cb)return!1;spotim_notifier=cb},Proto.set=function(callback){"function"==typeof callback&&Auth.initialize(function(events){Proto.isAuthenticated(function(props){Helper.log("is authenticated?",props.authenticated),_props=props,_events=events,spotim_notifier&&"function"==typeof spotim_notifier&&spotim_notifier(props,events),callback({authenticated:props.authenticated,userInfo:props.userInfo,token:props.token,events:events})})})},Proto.isAuthenticated=function(callback){Auth.MODE_silentLogin(function(props){callback(props)})},Proto.gotoPage=function(page){var url=null;switch(page){case"profile":url=config.profilePage}url&&window.open(url,"_self")},Proto.logout=function(){alert("todo: logout")}}});
Modulr.define("core.auth:models/script.loader",["require","jquery"],function(require,$){return function(src,callback){function onError(){throw new Error("Error loading script: "+src)}var BUILD_VERSION="function"==typeof Modulr.getGlobalCacheParam?Modulr.getGlobalCacheParam():null,isOpera=void 0!==window.opera&&"[object Opera]"===window.opera.toString()?1:navigator.userAgent.indexOf("Opera")>-1?1:0,script=document.createElement("script");script.async=!0,!script.attachEvent||script.attachEvent.toString&&script.attachEvent.toString().indexOf("[native code")<0||isOpera?(script.addEventListener("load",callback,!1),script.addEventListener("error",onError,!1)):script.attachEvent("onreadystatechange",callback),BUILD_VERSION&&(src=src+(src.indexOf("?")>-1?"&":"?")+"v="+BUILD_VERSION),script.src=src,document.getElementsByTagName("head")[0].appendChild(script)}});
Modulr.define("core.auth:models/spot.im",["require","jquery","config"],function(require,$,config){var App=function(){};return App.prototype.send=function(data,callback){console.log("spot receives:",data),callback("yup")},new App});
Modulr.define("core.auth:modules/navbar",["require","jquery","config","cdn"],function(require,$,config){var target=$("#account");if(0!==target.length){var protocol=(require("cdn"),["htt","ps:"].join(""));$(".user-profile.user-login.button").addClass("show"),require(["models/middleware"],function(Middleware){Middleware.set(function(props){props.authenticated?function(){var markup='<div class="user-profile">                    <a href="#" class="avatar">                        <div class="m">                            <img src="${avatar}" data-user-field="picture" alt="">                        </div>                    </a>                </div>';markup=markup.replace("${avatar}",props.userInfo[protocol+"//foxnews.com/picture"]),target.html(markup),target.addClass("logged-in"),target.find(".user-profile a.avatar").on("click",function(evt){return evt.preventDefault(),Middleware.gotoPage("profile"),!1})}():function(){target.find(".user-profile.user-login.button > a.login").on("click",props.events.startLogin),location.search.indexOf("launch_login_page=on")>-1&&props.events.startLogin()}()})})}});
Modulr.define("core.auth:modules/navbar.legacy",["require","jquery","config","cdn"],function(require,$,config){var target=$("#account");if(0!==target.length){target.addClass("network-access");var protocol=(require("cdn"),["htt","ps:"].join(""));require(["models/middleware"],function(Middleware){Middleware.set(function(props){props.authenticated?function(){var markup='<div class="desktop user-profile">                    <a href="#" class="avatar"><img src="${avatar}" data-user-field="picture" alt=""></a>                    <div id="profile-hover">                        <div>                            <span></span>                            <ul>                                <li><a target=_blank class="profile" href="#">Profile</a></li>                                <li><a class="logout" href="#">Log Out</a></li>                            </ul>                        </div>                    </div>                </div>                <div class="mobile-tablet">                    <div class="welcome">Welcome, <span>${username}</span></div>                        <div class="access">                        <a class="profile" href="#">Profile</a> |                        <a class="logout" href="#">Logout</a>                    </div>                </div>';markup=markup.replace("${avatar}",props.userInfo[protocol+"//foxnews.com/picture"]),target.html(markup),target.addClass("logged-in"),target.find("a.profile").on("click",function(evt){return evt.preventDefault(),Middleware.gotoPage("profile"),!1}),target.find(".user-profile a.avatar").on("click",function(evt){return evt.preventDefault(),Middleware.gotoPage("profile"),!1}),target.find("a.logout").on("click",props.events.startLogout)}():function(){target.html('<div class="access mobile-tablet"><a class="login" href="#">Login</a></div><a class="login desktop" href="#">Login</a>'),target.find("a.login").on("click",props.events.startLogin),location.search.indexOf("launch_login_page=on")>-1&&props.events.startLogin()}()})})}});
Modulr.define("core.auth:options",["require","jquery","cdn"],function(require,$){var CDN=require("cdn"),ssl=(CDN.domain,CDN.env,["htt","ps:"].join("")),options={};return options.localhost={default:{domain:"testing-foxnews.auth0.com",clientID:"3ys8tHNcg8hzzUeV-nizksE1lYw3bvBX",audience:ssl+"//sso.testing-foxnews.com/userinfo",redirectUri:window.location.protocol+"//global.fncstatic.com/static/orion/html/auth/Auth0/callback.html",responseType:"token id_token",responseMode:"fragment",scope:"openid email nickname"},silent:{usePostMessage:!0,postMessageDataType:"auth0"},popup:{}},options["lindahaviv.github.io"]={default:{domain:"testing-foxnews.auth0.com",clientID:"3ys8tHNcg8hzzUeV-nizksE1lYw3bvBX",audience:ssl+"//sso.testing-foxnews.com/userinfo",redirectUri:ssl+"//lindahaviv.github.io/auth0-good-poc/callback.html",responseType:"token id_token",responseMode:"fragment",scope:"openid email nickname"},silent:{usePostMessage:!0,postMessageDataType:"auth0"},popup:{}},options["aem-dev-publisher.foxnews.com"]={default:{domain:"my-dev.foxnews.com",clientID:"yFON2cS8aYLQVlMPqVnv87kmCyssN6Oq",audience:ssl+"//sso.foxnews-dev.com/userinfo",overrides:{__tenant:"foxnews-dev",__token_issuer:ssl+"//foxnews-dev.auth0.com/"},redirectUri:ssl+"//dev.static.foxnews.com/community/auth/user/callback.html",responseType:"token",responseMode:"fragment",scope:"openid email nickname"},silent:{usePostMessage:!0,postMessageDataType:"auth0"},popup:{}},options["aem-dev-publisher.foxbusiness.com"]={default:{domain:"my-dev.foxnews.com",clientID:"yFON2cS8aYLQVlMPqVnv87kmCyssN6Oq",audience:ssl+"//sso.foxnews-dev.com/userinfo",overrides:{__tenant:"foxnews-dev",__token_issuer:ssl+"//foxnews-dev.auth0.com/"},redirectUri:ssl+"//dev.static.foxnews.com/community/auth/user/callback.html",responseType:"token",responseMode:"fragment",scope:"openid email nickname"},silent:{usePostMessage:!0,postMessageDataType:"auth0"},popup:{}},options["beta.video.foxnews.com"]={default:{domain:"my-dev.foxnews.com",clientID:"yFON2cS8aYLQVlMPqVnv87kmCyssN6Oq",audience:ssl+"//sso.foxnews-dev.com/userinfo",overrides:{__tenant:"foxnews-dev",__token_issuer:ssl+"//foxnews-dev.auth0.com/"},redirectUri:ssl+"//dev.static.foxnews.com/community/auth/user/callback.html",responseType:"token",responseMode:"fragment",scope:"openid email nickname"},silent:{usePostMessage:!0,postMessageDataType:"auth0"},popup:{}},options["beta-drupal7.nation.foxnews.com"]={default:{domain:"my-dev.foxnews.com",clientID:"yFON2cS8aYLQVlMPqVnv87kmCyssN6Oq",audience:ssl+"//sso.foxnews-dev.com/userinfo",overrides:{__tenant:"foxnews-dev",__token_issuer:ssl+"//foxnews-dev.auth0.com/"},redirectUri:ssl+"//dev.static.foxnews.com/community/auth/user/callback.html",responseType:"token",responseMode:"fragment",scope:"openid email nickname"},silent:{usePostMessage:!0,postMessageDataType:"auth0"},popup:{}},options["foxnews.com"]={default:{domain:"my.foxnews.com",clientID:"DYfIjK4qF5e0soKD3cHasTsnp7KqYj0v",audience:ssl+"//sso.foxnews.com/userinfo",overrides:{__tenant:"foxnews",__token_issuer:ssl+"//foxnews.auth0.com/"},redirectUri:ssl+"//www.foxnews.com/community/auth/user/callback.html",responseType:"token",responseMode:"fragment",scope:"openid email nickname"},silent:{usePostMessage:!0,postMessageDataType:"auth0"},popup:{}},options["video.foxnews.com"]={default:{domain:"my.foxnews.com",clientID:"DYfIjK4qF5e0soKD3cHasTsnp7KqYj0v",audience:ssl+"//sso.foxnews.com/userinfo",overrides:{__tenant:"foxnews",__token_issuer:ssl+"//foxnews.auth0.com/"},redirectUri:ssl+"//www.foxnews.com/community/auth/user/callback.html",responseType:"token",responseMode:"fragment",scope:"openid email nickname"},silent:{usePostMessage:!0,postMessageDataType:"auth0"},popup:{}},options["nation.foxnews.com"]={default:{domain:"my.foxnews.com",clientID:"DYfIjK4qF5e0soKD3cHasTsnp7KqYj0v",audience:ssl+"//sso.foxnews.com/userinfo",overrides:{__tenant:"foxnews",__token_issuer:ssl+"//foxnews.auth0.com/"},redirectUri:ssl+"//www.foxnews.com/community/auth/user/callback.html",responseType:"token",responseMode:"fragment",scope:"openid email nickname"},silent:{usePostMessage:!0,postMessageDataType:"auth0"},popup:{}},options});
Modulr.define("core.auth:pages/callback",["require","jquery","config"],function(require,$,config){if(window.parent!==window.self){try{origin=window.parent&&window.parent.location.href||window.location.origin,console.log("origin try"+origin)}catch(e){origin=window.location.origin,console.log("origin catch"+origin)}parent.postMessage({type:"auth0",hash:window.location.hash},"*")}else!function(){require(["models/fnnauth","models/callback"],function(Authentication,Callback){Callback(new Authentication(config.hostname)),Authentication.handleCallback()})}()});
Modulr.define("core.auth:pages/iframe",["require","jquery","lodash","config","models/fnnauth"],function(require,$,_,config){window.parent!==window.self&&window.location.search&&function(){require(["models/fnnauth"],function(Authentication){var sendMessage=function(name,data){parent.postMessage({name:name,data:data,type:"fnnBrokerResponse"},qs.origin)},dispatch=function(event){event.origin===qs.origin&&event.data&&"fnnBrokerRequest"===event.data.type&&("silentLogin"===event.data.name?Auth.MODE_silentLogin(function(auth){Auth.getUserProfile(function(err,userProfile){auth.userInfo=userProfile,sendMessage(event.data.name,auth)})}):"startLogin"===event.data.name?Auth.startIframeLogin(event.data.data,function(url){sendMessage(event.data.name,url)}):"startLogout"===event.data.name&&Auth.startIframeLogout(function(err){sendMessage(event.data.name,err)}))},qs=function(){for(var vars={},params=window.location.search.substr(1).split("&"),i=0;i<params.length;i++)keyValue=params[i].split("="),vars[keyValue[0]]=decodeURIComponent(keyValue[1]);return vars}();if(qs.domain&&qs.origin&&"undefined"!==qs.domain){var Auth=new Authentication(qs.domain);window.addEventListener("message",dispatch),sendMessage("ready")}})}()});
Modulr.define("core.auth:pages/profile",["require","jquery","config","helper","models/fnnauth"],function(require,$,config,Helper){var Authentication=require("models/fnnauth"),Auth=new Authentication(config.hostname);Helper.log("core auth loaded",Auth),Auth.initialize("profile","login-container")});
!function(Modulr,FNC){if(Modulr.getInstance("core.auth"))return!1;var config={instance:"core.auth",baseDomain:FNC.CDN.domain,baseUrl:"/static/orion/scripts/core/auth/app",masterFile:"/static/orion/scripts/core/utils/modulr/master.js",paths:{},packages:["core.plugins"],shim:{jquery:{src:"/static/orion/scripts/core/utils/jquery/core.js",exports:"jQuery"},lodash:{src:"/static/orion/scripts/core/utils/lodash.js",exports:"_"},"akamai.time":{src:"//global.fncstatic.com/static/v/all/js/geo.js",exports:"AKAMAI_TIME_HELPER"}}},Instance=Modulr.config(config);Instance.define("cdn",function(){return FNC.CDN}),window.FNC.core=window.FNC.core||{},window.FNC.core.auth=window.FNC.core.auth||function(){var App=function(){};return App.prototype.init=function(callback){($('meta[name="auth_type"]').attr("content")||null)&&Instance.require(["index"],function(App){"function"==typeof callback&&callback(App)})},App.prototype.set=function(callback){$('meta[name="auth_type"]').attr("content")||null||Instance.require(["api"],function(API){"function"==typeof callback&&callback(API)})},App.prototype.isAuthenticated=function(callback){Instance.require(["api"],function(API){"function"==typeof callback&&callback(API.isAuthenticated())})},new App}()}(window.Modulr,function(){return window.FNC=window.FNC||{},window.FNC.CDN=window.FNC.CDN||function(){function idx(e,v){return e.indexOf(v)>-1?1:0}for(var type="prod",found=!1,scripts=document.getElementsByTagName("script"),i=0;i<scripts.length;i++){var src=scripts[i].getAttribute("src")||"";if(src&&(idx(src,"fncstatic.com/static/")||idx(src,"foxnews.com/static/")||idx(src,"foxbusiness.com/static/")||idx(src,"/static/v"))){found=src;break}}found&&(idx(found,"qa.global.")||idx(found,"-qa.")?type="qa":idx(found,"staging.")?type="staging":idx(found,"global.fncstatic")||(type="relative"));var domain="global.fncstatic.com",env="relative"===type?"prod":type;switch(type){case"qa":domain="qa."+domain;break;case"staging":domain=["v8-staging","foxnews.com"].join(".");break;case"relative":domain=window.location.host}return domain="//"+domain,window.FOX_ENV_STATIC_DOMAIN=domain,window.FOX_ENV_STATIC=env,{domain:domain,env:env}}(),window.FNC}());