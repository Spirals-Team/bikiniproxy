new function($){$.fn.extend({showAndEnableQuestion:function(enable){enable?this.removeData("hiddenByCondition"):this.data("hiddenByCondition",1);this.showAndEnable(enable)},enableQuestion:function(enable){enable?this.removeData("hiddenByCondition"):this.data("hiddenByCondition",1);this.enable(enable)},showQuestion:function(enable){enable?this.removeData("hiddenByCondition"):this.data("hiddenByCondition",1);this.show(enable)}});window.FormFiller=function(el){var _this=this,form=el,inited=!1,fields={},serverLogicFunctions=[],initialLogicExecution=!1,readOnlyStyle={border:"1px solid #cccccc",color:"#666666"},init=function(){var qs,i,q,rs,rs2;if(inited!=!0)for(inited=!0,qs=form.find(".form_question"),i=0;i<qs.length;i++){if(q=qs.eq(i),rs=q.find("input[type=checkbox],input[type=radio],input[type=text],input[type=email],input[type=tel],input[type=file],select,textarea"),q.data("disabled")=="1")rs.prop("disabled",!0).attr("data-disabled","1").css(readOnlyStyle);else if(q.data("readonly")=="1")rs.prop("readOnly",!0).css(readOnlyStyle),rs2=q.find("input[type=checkbox],input[type=radio],input[type=file],select"),rs2.length>0&&(rs2.prop("disabled",!0).attr("data-disabled","1"),rs2.each(function(){var rs2el=$(this),hf=$('<input type="hidden" />').attr("name",rs2el.attr("name")).attr("id",rs2el.attr("id")+"_hidden").insertBefore(rs2el);rs2el.on("change",function(){var id=$(this).prop("id")+"_hidden",rshf=$(document.getElementById(id)),text;rshf.val($(this).val());text=$(this).text();$(this).is("select")&&(text=$(this).find("option:selected").text());rshf.attr("data-text",text);$(this).is("input[type=checkbox],input[type=radio]")&&rshf.prop("disabled",!$(this).prop("checked"))}).triggerHandler("change")}));else{rs.on("click",change).on("keyup",change).on("change",change);q.data("required")=="1"&&rs.attr("aria-required","true")}fields[q.data("export")==null?q.data("id"):q.data("export")]=q.data("id")}},change;this.ready=function(){};this.filterArray=function(array,filterByArray){var arrayOut,i;for($.isArray(filterByArray)||(filterByArray=[filterByArray]),arrayOut=[],i=0;i<array.length;i++)filterByArray.indexOf(array[i])>-1&&arrayOut.push(array[i]);return arrayOut};this.appendServerLogic=function(event){serverLogicFunctions.push(event)};this.initializeLogic=function(){initialLogicExecution=!0;for(var i=0;i<serverLogicFunctions.length;i++)serverLogicFunctions[i]();form.find('.form_responses:has([data-handler-change="1"])').each(function(){$(this).find("[data-handler-change]:eq(0)").triggerHandler("change")});form.find('.form_responses [data-bubbling="1"]').attr("data-bubbling",null);form.find(".form_loading:eq(0)").hide();form.find(".form_pages:eq(0)").show();$(".form_action").show();initialLogicExecution=!1};this.getForm=function(){return form};this.getItem=function(selectorPrefix,selectorSuffix,args){for(var el2,el=null,i=0;i<args.length;i++)el2=form.find(selectorPrefix+FW.escapeSelector(args[i])+selectorSuffix),el=el==null?el2:el.add(el2);return el==null&&(el=$([])),el};this.getSection=function(){return this.getItem('.form_page[data-export="','"]',arguments)};this.getSectionById=function(){return this.getItem('.form_page[data-id="','"]',arguments)};this.getQuestion=function(){return this.getItem('.form_question[data-export="','"]',arguments)};this.getQuestionById=function(){return this.getItem('.form_question[data-id="','"]',arguments)};this.getFieldTypeById=function(){return this.getItem('.form_question[data-id="','"]',arguments).data("type")};this.getFieldDataTypeById=function(){return this.getItem('.form_question[data-id="','"]',arguments).data("datatype")};this.getElementById=function(){var item=this.getItem('[name^="form_','"]',arguments);return item&&item.length!=0||(item=this.getQuestionById(arguments[0]).find("[name]")),item};this.getElement=function(){var item=this.getItem('[name^="form_','"]',$.map(arguments,function(arr){return fields[arr]}));return item&&item.length!=0||(item=this.getQuestion(arguments[0]).find("[name]")),item};this.getValueById=function(id){var type=this.getFieldTypeById(id),dataType=this.getFieldDataTypeById(id),val=this.getValueArrayById(id);return val.length==0?null:type=="birthdate"||type=="date"||type=="calendar"||dataType=="int"||dataType=="real"||dataType=="date"||dataType=="datetime"?val[0]:val.join(",")};this.getValue=function(key){var val=this.getValueArray(key);return val.length==0?null:val.length==1?val[0]:val.join(",")};this.getText=function(key){var val=this.getTextArray(key);return val.length==0?null:val.length==1?val[0]:val.join(",")};this.getLocalDate=function(date){return new Date(date.getTime()+date.getTimezoneOffset()*6e4)};this.getValueArray=function(key){return this.getValueArrayById(fields[key])};this.getTextArray=function(key){return this.getTextArrayById(fields[key])};this.getTextArrayById=function(id){return this.getValueArrayByIdValue(id,"text")};this.getValueArrayById=function(id){return this.getValueArrayByIdValue(id,"value")};this.getValueArrayByIdValue=function(id,valuetype){var type=this.getFieldTypeById(id),dataType=this.getFieldDataTypeById(id),val2,field_val,address,val,self;if(dataType||(dataType="text"),val2=[],type=="date"||type=="birthdate"){field_val="";form.find('[name="form_'+id+'"]:enabled').val()?field_val=form.find('[name="form_'+id+'"]:enabled').val():form.find('[name="form_'+id+'_y"]:enabled').val()&&form.find('[name="form_'+id+'_m"]:enabled').val()&&form.find('[name="form_'+id+'_d"]:enabled').val()&&(field_val+=form.find('[name="form_'+id+'_y"]:enabled').val()+"-"+form.find('[name="form_'+id+'_m"]:enabled').val()+"-"+form.find('[name="form_'+id+'_d"]:enabled').val());try{field_val=this.getLocalDate(new Date(field_val))}catch(ex){}val2.push(field_val)}else if(type=="dateym"){field_val="";form.find('[name="form_'+id+'"]:enabled').val()?field_val=form.find('[name="form_'+id+'"]:enabled').val():form.find('[name="form_'+id+'_y"]:enabled').val()&&form.find('[name="form_'+id+'_m"]:enabled').val()&&(field_val+=form.find('[name="form_'+id+'_y"]:enabled').val()+"-"+form.find('[name="form_'+id+'_m"]:enabled').val()+"-01");try{field_val=this.getLocalDate(new Date(field_val))}catch(ex){}val2.push(field_val)}else if(type=="datemd"){field_val="";form.find('[name="form_'+id+'"]:enabled').val()?field_val=form.find('[name="form_'+id+'"]:enabled').val():form.find('[name="form_'+id+'_m"]:enabled').val()&&form.find('[name="form_'+id+'_d"]:enabled').val()&&(field_val+=(new Date).getFullYear().toString()+"-"+form.find('[name="form_'+id+'_m"]:enabled').val()+"-"+form.find('[name="form_'+id+'_d"]:enabled').val());try{field_val=this.getLocalDate(new Date(field_val))}catch(ex){}val2.push(field_val)}else type=="address"?(address={},address.street=form.find('[name="form_'+id+'_street"]:enabled').val(),address.region=form.find('[name="form_'+id+'_region"]:enabled').val(),address.country=form.find('[name="form_'+id+'_country"]:enabled').val(),address.city=form.find('[name="form_'+id+'_city"]:enabled').val(),address.postal=form.find('[name="form_'+id+'_postal"]:enabled').val(),val2.push(address)):(val=form.find('[name="form_'+id+'"]:enabled'),val.length==0&&(val=this.getQuestionById(id).find("[name]:enabled")),val.length>0&&(val=val.filter("input[type=checkbox]:checked,input[type=radio]:checked,input[type=text],input[type=hidden],input[type=email],input[type=tel],textarea,select"),val.is("select")&&(val=val.find("option:selected")),self=this,val.each(function(){var field_val=valuetype=="text"?$(this).attr("data-text"):$(this).val();if((dataType=="int"||dataType=="real")&&(field_val=field_val.replace(/[^\d.-]/g,"")),dataType=="int")field_val=parseInt(field_val,10);else if(dataType=="real")field_val=parseFloat(field_val);else if(type=="calendar"||dataType=="date"||dataType=="datetime")try{field_val=self.getLocalDate(new Date(field_val))}catch(ex){}val2.push(field_val)})));return val2};this.getValueForCalculation=function(key){var question=this.getQuestion(key),val,selected,newval;if(question.length>1&&question.has(":input:enabled").length>0&&(question=question.has(":input:enabled")),val=0,$.inArray(question.data("datatype"),["int","real"])>=0&&$.inArray(question.data("type"),["select","checkbox","radio","likert","text","selectable"])>=0){switch(question.data("type")){case"select":val=question.find("option:selected").val();val&&val.length>10&&(val=question.find("option:selected").text());break;case"checkbox":case"selectable":case"radio":selected=question.find("input:checked");val=selected.val();val&&val.length>10&&(val=question.find("label[for="+selected.prop("id")+"]").text());break;case"likert":selected=question.find("input:checked");val=selected.val();val&&val.length>10&&(val=selected.data("label"));break;case"text":val=question.find(":input").val()}if(val&&(val=val.replace(/[^\d.-]/g,"")),question.data("datatype")=="int")val=parseInt(val,10);else if(question.data("datatype")=="real")val=parseFloat(val);else if(question.data("datatype")=="date"||question.data("datatype")=="datetime")try{newval=self.getLocalDate(new Date(val));val=newval}catch(ex){}}else val=this.getValue(key);return typeof val=="number"&&isNaN(val)?0:val};this.setValue=function(key,value){var val=form.find('[name="form_'+fields[key]+'"]'),nodes=val.filter("input[type=text],input[type=email],input[type=tel],textarea"),i;if(nodes.length==1){nodes.val(value);return}for(nodes=val.filter("input[type=checkbox],input[type=radio],select"),nodes.is("select")&&(nodes=nodes.find("option")),i=0;i<nodes.length;i++)nodes.eq(i).val()==value&&(nodes.eq(i).prop("nodeName")=="OPTION"?nodes.eq(i).prop("selected",!0):nodes.eq(i).prop("checked",!0))};this.addCountdown=function(key,count,isWords){var el=this.getElement(key),helpName,countConfig;isWords||el.attr("maxlength",count);helpName=key.replace(/[ :]/g,"_");countConfig="{ help: '#"+helpName+"_maxlength'";countConfig+=isWords?", words: "+count+" }":" }";el.attr("data-maxlength",countConfig);el.after("<div id='"+helpName+"_maxlength' style='text-align: right; color: inherit; width:370px;'>"+count+" "+(isWords?"words":"characters")+" remaining<\/div>")};this.addCharacterCountdown=function(key,charCount){this.addCountdown(key,charCount,!1)};this.addWordCountdown=function(key,wordCount){this.addCountdown(key,wordCount,!0)};change=function(event){var self=$(this),el=self.parents("div.form_question").eq(0),el2,type,field,country,hasFile,hasText,mask;if(el.hasClass("required")){if(el2=el.find(".form_responses"),type=el.data("type"),type=="text"||type=="email"||type=="tel"){if(el2.find("input").val()=="")return}else if(type=="textarea"){if(el2.find("textarea").val()=="")return}else if(type=="select"||type=="multiselect"){if(el2.find("select").val()=="")return}else if(type=="checkbox"||type=="radio"||type=="likert"){if(el2.find("input:checked").length==0)return}else if(type=="birthdate"||type=="date"){if(field=el2.find("select"),field.eq(0).val()==""||field.eq(1).val()==""||field.eq(2).val()=="")return}else if(type=="dateym"||type=="datemd"){if(field=el2.find("select"),field.eq(0).val()==""||field.eq(1).val()=="")return}else if(type=="address"){if(country=el2.find("select:last").val(),el2.find("textarea").val()==""||el2.find("input[type=text]").eq(0).val()=="")return;if(country=="US"&&field==null&&(field=el2.find("select:visible").eq(0),field.val()==""))return}else if(type=="location"){if(el2.find("input[type=text]").eq(0).val()=="")return}else if(type=="plugin:event"){if(el2.find("input:checked").length==0)return}else if(type=="plugin:material"){if(hasFile=el2.find("input[type=file]").eq(0).val(),hasText=el2.find("textarea").eq(0).val(),!(hasText||hasFile))return}else return;el.removeClass("required");el.find('[aria-invalid = "true"]').attr("aria-invalid","false")}self.is("input")&&event.type=="change"&&(mask=el.data("mask"),mask!=null&&mask.length>0&&FW.ValidateMask(self,mask))};this.Validate=function(silent){for(var country,hasFile,hasText,mask,req_hit,val,result,req_el=null,req_count=0,mask_count=0,reqs=null,reqs=form.find('.form_question[data-required = "1"],.form_question[data-mask]'),i=0;i<reqs.length;i++){var el=reqs.eq(i),el2=el.find(".form_responses"),field=null,type=el.data("type");(el2.find("input:enabled:visible,select:enabled:visible,textarea:enabled:visible").length!=0||type=="selectable")&&(el.data("required")==1&&(req_hit=!0,type=="text"||type=="email"||type=="tel"?(field=el2.find("input"),field.val()!=""&&(req_hit=!1)):type=="textarea"?(field=el2.find("textarea"),field.val()!=""&&(req_hit=!1)):type=="select"||type=="multiselect"?(field=el2.find("select"),field.val()!=""&&el2.find("select").prop("selectedIndex")>-1&&(req_hit=!1)):type=="checkbox"||type=="radio"||type=="likert"||type=="selectable"?(el2.find("input:checked").length>0&&(req_hit=!1),field=el2.find("input").eq(0)):type=="birthdate"||type=="date"?(field=el2.find("select"),field.eq(0).val()!=""&&field.eq(1).val()!=""&&field.eq(2).val()!=""&&(req_hit=!1)):type=="dateym"||type=="datemd"?(field=el2.find("select"),field.eq(0).val()!=""&&field.eq(1).val()!=""&&(req_hit=!1)):type=="address"?(field=el2.find("textarea"),field.val()!=""&&(field=null),field==null&&(field=el2.find("input[type=text]").eq(0),field.val()!=""&&(field=null)),country=el2.find("select:last").val(),country=="US"&&field==null&&(field=el2.find("select:visible").eq(0),field.val()!=""&&(field=null)),field==null&&(req_hit=!1)):type=="location"?(field=el2.find("input[type=text]").eq(0),field.val()!=""&&(req_hit=!1)):type=="plugin:event"?(field=el2.find("input[type=checkbox]").eq(0),el2.find("input:checked").length>0&&(req_hit=!1)):type=="plugin:material"?el2.find('[data-validate-fulfilled="1"]').length>0?req_hit=!1:(field=el2,hasFile=el2.find("input[type=file]").eq(0).val(),hasText=el2.find("textarea").eq(0).val(),(hasText||hasFile)&&(req_hit=!1)):req_hit=!1,req_hit==!0&&(req_count++,el.addClass("required"),field.attr("aria-invalid","true"),req_el==null&&(req_el=field))),el.data("mask")!=null&&(mask=el.data("mask"),mask!=""&&(req_hit=!0,el.hasClass("form_text")?(field=el2.find("input"),val=field.val(),val==""?req_hit=!1:(result=FW.ValidateMask(field,mask),result==!0&&(req_hit=!1))):req_hit=!1,req_hit==!0&&(mask_count++,el.addClass("required"),field.attr("aria-invalid","true"),req_el==null&&(req_el=field)))))}return req_el==null?!0:silent==!0?!1:(FW.Dialog.Load($('<div class="dialog" style="width: 400px;"><div style="padding: 50px 25px;"><div role="alert" style="color: #cc0000; text-align: center; font-weight: bold;">'+(req_count==0?"":req_count.toString()+" required field"+(req_count==1?" was":"s were")+" not completed")+(req_count==0||mask_count==0?"":" and ")+(mask_count==0?"":mask_count.toString()+" field"+(mask_count==1?" was":"s were")+" not properly formatted")+".<\/div><\/div><\/div>")),window.setTimeout(function(){FW.Dialog.Unload();var el=req_el.parents(".form_question").eq(0),scroller=el.getVerticalScroller();scroller==null?req_el.focus():scroller.animate({scrollTop:scroller.prop("nodeName")=="HTML"||scroller.prop("nodeName")=="BODY"?el.offset().top-25:el.position().top-25+scroller.scrollTop()},500,function(){req_el.focus()})},2500),!1)};this.Submit=function(){return this.Validate()?(FW.Postback(form),!0):!1};this.applyConditionalLogicRecursive=function(el){el=$(el);el.find('.form_responses:has([data-handler-change="1"])').each(function(){var el2=$(this).find("[data-handler-change]:eq(0)");el2.attr("data-bubbling")!="1"&&(el2.attr("data-bubbling","1"),el2.triggerHandler("change"))});initialLogicExecution||window.setTimeout(function(){el.find('[data-bubbling="1"]').attr("data-bubbling",null)},25)};this.applyConditionalPrompts=function(field){var fieldConditions,choicesToShow,filteredChoices,showQuestion,optionsToShow,possibleOptions;if(!(form.find(".form_pages.readOnly").length>0)&&(fieldConditions=$.grep(this.conditionalPromptConfig,function(item){return item.field==field}),fieldConditions!=null&&fieldConditions.length!=0)){fieldConditions=fieldConditions[0];choicesToShow=[];filteredChoices=[];$.each(fieldConditions.conditions,function(i,item){item.condition(_this)&&$.merge(choicesToShow,item.prompts);$.merge(filteredChoices,item.prompts)});var targetQuestion=this.getQuestionById(field),targetType=targetQuestion.data("type"),targetInput=targetType=="selectable"?"checkbox":targetType,target=this.getElementById(field);if(target.data("stack")!=!0){target.data("stack",!0);showQuestion=!1;switch(targetType){case"select":case"multiselect":optionsToShow=target.find("option").filter(function(){return $.inArray(this.value,choicesToShow)>=0});possibleOptions=target.find("option").filter(function(){return $.inArray(this.value,filteredChoices)>=0});optionsToShow.showOption();possibleOptions.not(optionsToShow).hideOption();target.hideOptionGroups();showQuestion=target.children("option:not(:empty)").add(target.children("optgroup").children("option:not(:empty)")).length>0;break;case"checkbox":case"radio":case"selectable":optionsToShow=target.filter(function(){return $.inArray(this.value,choicesToShow)>=0});possibleOptions=target.filter(function(){return $.inArray(this.value,filteredChoices)>=0});(targetQuestion.data("hiddenByCondition")!="1"||targetQuestion.data("hiddenByConditionalPrompts")=="1")&&optionsToShow.parent().showAndEnable(!0);possibleOptions.not(optionsToShow).parent().showAndEnable(!1);showQuestion=targetQuestion.find(":"+targetInput+":enabled").length>0}target.triggerHandler("change");showQuestion&&(targetQuestion.data("hiddenByCondition")!="1"||targetQuestion.data("hiddenByConditionalPrompts")=="1")?(targetQuestion.data("hiddenByConditionalPrompts","0"),targetQuestion.show(!0)):showQuestion||(targetQuestion.data("hiddenByCondition")!="1"&&targetQuestion.data("hiddenByConditionalPrompts","1"),targetQuestion.show(!1));target.data("stack",!1)}}};this.getAllExportLabels=function(){var elements=form.find("[data-export]"),exports=elements.map(function(){return $(this).data("export")}).get();return exports.sort(function(a,b){return b.length-a.length})};this.initializeCalculatedFields=function(){var exportLabels=this.getAllExportLabels(),calculatedFields=form.find("[data-formula]"),frm=this;calculatedFields.each(function(i,item){frm.initializeCalculatedField(item,exportLabels)})};this.initializeCalculatedField=function(fld,exports){var frm=this,driverFields=[],originalFormula=$(fld).data("formula"),formula=originalFormula,calcHandler;typeof formula=="string"&&formula.indexOf("translate(")>=0&&(formula=formula.replace(/translate\(/g,"frm.translate("));$.each(exports,function(i,exp){typeof formula=="string"&&formula.indexOf("@"+exp)>=0&&(driverFields.push(exp),formula.indexOf("@"+exp+"_text")>=0&&(formula=formula.replace(new RegExp("@"+FW.escapeRegEx(exp+"_text"),"gi")," frm.getText('"+exp+"') ")),formula.indexOf("@"+exp+"_exact")>=0&&(formula=formula.replace(new RegExp("@"+FW.escapeRegEx(exp+"_exact"),"gi")," frm.getValue('"+exp+"') ")),formula.indexOf("@"+exp)>=0&&(formula=formula.replace(new RegExp("@"+FW.escapeRegEx(exp),"gi")," frm.getValueForCalculation('"+exp+"') ")))});calcHandler=function(){var self=$(this),result;if(self.data("calc-stack")!="1"){self.data("calc-stack","1");try{result=eval(formula);typeof result=="number"&&isNaN(result)||$(fld).val(result).triggerHandler("change")}catch(ex){alert("The following error occurred:\n"+ex.toString()+"\n\nwhile evaluating the formula:\n"+originalFormula)}self.data("calc-stack",null)}};$(function(){$.each(driverFields,function(i,drv){frm.getElement(drv).on("change",calcHandler)});$(fld).on("recalculate",calcHandler);calcHandler()})};this.translate=function(translatorName,value){if(!this.translators||!this.translators[translatorName])return"";var translator=this.translators[translatorName],found=!1,result="",translation=$.grep(translator.translations,function(item){return translator.type=="string"?item.minValue==value:item.minValue<=value&&value<=item.maxValue});return translation&&translation.length>0&&(found=!0,result=translation[0].export),!found&&translator.default&&(result=translator.default),translator.resultType=="int"&&(result=parseInt(result)),translator.resultType=="real"&&(result=parseFloat(result)),(translator.resultType=="int"||translator.resultType=="real")&&isNaN(result)&&(result=0),result};this.initializeFieldLimits=function(){var frm=this,limitedFields=form.find("[data-limit]");limitedFields.each(function(i,item){frm.initializeFieldLimit(item)})};this.initializeFieldLimit=function(fld){fld=$(fld);var limit=fld.data("limit"),type=fld.data("type");if(type=="checkbox"||type=="plugin:event"||type=="selectable")fld.find(":checkbox").on("change",function(){var numChecked=fld.find(":checkbox:checked").length;$(this).is(":checked")&&numChecked>parseInt(limit)&&((type="selectable"&&limit=="1")?fld.find(":checkbox:checked").not(this).prop("checked",!1):$(this).prop("checked",!1))})};init()}}(FW.$);