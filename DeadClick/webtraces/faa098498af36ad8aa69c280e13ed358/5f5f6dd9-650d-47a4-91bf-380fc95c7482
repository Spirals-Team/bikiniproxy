 
(function () {
    tp = window["tp"] || [];

    /* Checkout related */
    /**
     * Event properties
     *
     * chargeAmount - amount of purchase
     * chargeCurrency
     * uid
     * email
     * expires
     * rid
     * startedAt
     * termConversionId
     * termId
     * promotionId
     * token_list
     * cookie_domain
     * user_token
     *
     */

    var endpoint = typeof(CNBC_Utils) === 'object' ? CNBC_Utils.searchProp(CNBC_Premium, 'globals->config->endpoint') : '',
        checkoutCompleted = false,
        closeEventHandled = false,
        bedrockSyncErrorMsg = null,
        isMobile = (function() {
            var mobile = false, evt;
            try {
                evt = document.createEvent('TouchEvent');
                mobile = true;
            } catch(e) {}

            return mobile;
        }()),
        syncApiUrl = typeof(CNBC_Settings) === 'object' ? CNBC_Settings.baseurls.register_base.split(":")[1] + '/auth/api/' : 'http://wjfkdsj.hdkfjhkjdshkfjdkjsdkfjshd.com/',
        isPremiumPage = typeof(CNBC_Premium) === 'object' ? CNBC_Premium.isPremium : false;

    var displayBedrockSyncErrorMsg = function() {
        if (!bedrockSyncErrorMsg) {
            bedrockSyncErrorMsg = new CNBC_Popup2();
            var errorConfig = {
                closeOnBackgroudClick: false,
                popupId: 'bedrockSyncErrorMsg',
                popupContent: '<div style="clear:both;"></div>'
                +'<div class="popup-body">'
                +'<div class="header">Oops!</div>'
                +'<div class="body">Please call customer service if you encounter any problems accessing Premium content</div>'
                +'</div>'
                +'<hr style="width:85%;margin-top: 20px;margin-bottom: 20px;border: 0;border-top: 1px solid #eee;">'
                +'<div class="popup-footer">'
                +'<button class="button cancel">OK</button>'
                +'</div>',
                initCallback: null,
                autoAlignPopup: true,
                autoHide: true,
                minHeight : '200px',
                minWidth : (CNBC_Premium.globals.product === 'web') ? '400px' : '25%'
            };
            bedrockSyncErrorMsg.init(errorConfig);
            $('#bedrockSyncErrorMsg  .cancel').on('click', function() {
                bedrockSyncErrorMsg.hide();
            });
        };
        bedrockSyncErrorMsg.show();
    }

    function onCheckoutComplete(completeCallback, customEventCallback) {
		console.log('called: onCheckoutComplete');
        //styling refinements to mobile interstitial
        if(isMobile && window.innerWidth <= 450) {
            $('.tp-iframe-wrapper').css('margin', '0px auto');
            $('.tp-iframe-wrapper iframe').height(window.innerHeight).css('position', 'relative');
        }

        //styling refinements to both web + mobile interstitial
        $('.tp-iframe-wrapper iframe').addClass("thank-you-interstitial");
        $('.tp-close.tp-active').addClass("thank-you-interstitial");

        //attach google analytics tag to close button
        $('.tp-modal .tp-close').on('click', function() {
            //_gaq.push(['_trackEvent', 'button', 'click', 'close']);
        })
        
        //sync with bedrock to process user login
        if (typeof(localStorage) === 'object' && localStorage.getItem('1258')) {
            syncApiUrl = 'http://wjfkdsj.hdkfjhkjdshkfjdkjsdkfjshd.com/';
        }

        if(typeof(CNBC_Bedrock) === 'object') {
            CNBC_Bedrock.syncApi.syncCall({
                uuid: SURF.globals.user._provider.cnbc,
                pid: 152,
                action: 'subscription',
                dataType: 'json',
                url: syncApiUrl,
                success: function (data, text, status) {},
                error: function (data, text, status) {
                    displayBedrockSyncErrorMsg();
                }
            });
        }

        //set checkout flag to true
        checkoutCompleted = true;

        //set isPro cookie to true
        CNBC_Utils.createProCookie();

        //place tracking for checkout confirmation
        CNBC_Omniture.genericClickTracking({
            'pageName': 'Registration|Pro|Payment Confirmation',
            'props': {
                '1': 'franchise',
                '10': 'Registration',
                '16': 'registration',
                '31': 'Registration Pages',
                '32': 'Pro',
                '37': 'franchise'
            }
        });

        //fire google analytics call for suscription complete
        //_gaq.push(['_trackEvent', 'button', 'click', 'subscribe']);
    }

    function onCheckoutExternalEvent() {

    }

    function onCheckoutClose(event) {
        // Default behavior is to refresh the page on successful checkout
        var isPremiumPage = CNBC_Premium.isPremium;
        // TP is calling this event twice! (Yes, I know....)
        // we need to handle only once.
        if (!closeEventHandled) {
            closeEventHandled = true;
            if (checkoutCompleted) {
                if (isPremiumPage) {
                    //refresh the page on default behavior
                    window.location.reload();
                } else {
                    //if url is a service, call the service; otherwise redirect to home
                    var docref = CNBC_Utils.urlParam('service') ? window.decodeURIComponent(CNBC_Utils.urlParam('service')) : CNBC_Settings.baseurls.pub_base_protocol_agnostic;
                    window.location.href = docref;
                }
            }
        }
    }

    function onCheckoutCancel() {
		console.log("called: onCheckoutCancel");
    }

    function onCheckoutError() {
		console.log("called: onCheckoutError");
    }

    /* Meter callback */
    function onMeterExpired() {
		console.log("called: onMeterExpired");

    }

    /* Meter callback */
    function onMeterActive() {
		console.log("called: onMeterActive");

    }

    /* Callback executed when a user must login */
    function onLoginRequired() {
        console.log('called: onLoginRequired')
        // this is a reference implementation only
        // your own custom login/registration implementation would
        // need to return the tinypass-compatible userRef inside the callback

        // mysite.showLoginRegistration(function (tinypassUserRef)
        //tp.push(["setUserRef", tp.userRef]); // tp.offer.startCheckout(params); // }
        // this will prevent the tinypass error screen from displaying

        return false;
    }

    /* Callback executed after a tinypassAccounts login */
    function onLoginSuccess() {
		console.log("called: onMetonLoginSuccesserActive");
    }

    tp.push(["setAid", 'o19WonOrHQ']);
    tp.push(["setEndpoint", 'https://buy.tinypass.com/api/v3']); 
    tp.push(["setUseTinypassAccounts", false ]);

    /* checkout related events */
    tp.push(["addHandler", "checkoutComplete", onCheckoutComplete]);
    tp.push(["addHandler", "checkoutClose", onCheckoutClose]);
  //tp.push(["addHandler", "checkoutCustomEvent", onCheckoutExternalEvent]);
    tp.push(["addHandler", "checkoutCancel", onCheckoutCancel]);
    tp.push(["addHandler", "checkoutError", onCheckoutError]);
  //tp.push(["addHandler", "checkoutCustomEvent", paywallCustomEventCallback ]);


    /* user login events */
    tp.push(["addHandler", "loginRequired", onLoginRequired]);
    tp.push(["addHandler", "loginSuccess", onLoginSuccess]);

    /* meter related */
    tp.push(["addHandler", "meterExpired", onMeterExpired]);
    tp.push(["addHandler", "meterActive", onMeterActive]);
  
  
  	tp.push(['setTrackPages', false]);
})();


// do not change this section
// |BEGIN INCLUDE TINYPASS JS|
//console.log('begin include tinypass.js');
/* (function(src){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src=src;var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)})("https://cdn.tinypass.com/api/libs/tinypass.js"); */
// |END   INCLUDE TINYPASS JS|
