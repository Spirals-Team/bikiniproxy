/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2011 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(function(a){a.Util.require("s7sdk.common.Geometry");a.Util.require("s7sdk.event.Event");if(!a.Resolution){a.Resolution=function(i,d,g,e,c,b){this.view=b;this.level=i;this.w=d;this.h=g;this.loadTiles=0;var f=Math.ceil(d/256)*Math.ceil(g/256);this.tiles=new Array(f);this.url=e+(e.indexOf("?")>=0?"&":"?")+"scl="+Math.pow(2,i);this.fmt=c;this.transparent=((this.fmt.indexOf("png")!=-1||this.fmt.indexOf("gif")!=-1)&&(this.fmt.indexOf("-alpha")>0))?true:false;this.tileWidth=0;this.tileHeight=0;this.invalidTiles=new Array()};a.Resolution.prototype.nTiles=function(){return Math.ceil(this.w/256)*Math.ceil(this.h/256)};a.Resolution.prototype.getCreateTile=function(c){if(this.tiles[c.idx]==null){this.tiles[c.idx]=new a.Tile(this.level,c,this.url,this.fmt,this.loadTiles)}else{var b=this.tiles[c.idx];if(this.loadTiles>=0&&!b.loadSent){b.loadTile(this.loadTiles);b.image.resolutionBuffer=this}}return this.tiles[c.idx]};a.Resolution.prototype.getTile=function(b){return this.tiles[b]};a.Resolution.prototype.intersect=function(l,k,n,g){var b;var p;var i=Math.max(0,Math.floor(l/256)*256);var e=i;var d=Math.max(0,Math.floor(k/256)*256);var f=Math.ceil(this.w/256);var o=new Array();var m;var c;var j;this.tileHeight=0;while(d<k+g&&d<this.h){this.tileWidth=0;p=d/256;while(e<l+n&&e<this.w){b=e/256;m=p*f+b;c=Math.min(this.w-e,256);j=Math.min(this.h-d,256);o.push(new a.TileAddress(c,j,m,b,p));e+=256;this.tileWidth+=256}d+=256;this.tileHeight+=256;e=i}return o};a.Resolution.onResInvalidated=function(c){var b=a.Event.getTarget(c)};a.Resolution.onTileLoad=function(c){var b=a.Event.getTarget(c);if(b.resolutionBuffer!=null){b.resolutionBuffer.view.invalidated=true;b.resolutionBuffer=null;b.removeEventListener(a.Event.TILE_LOADED,a.Resolution.onTileLoad,true)}};a.Resolution.prototype.draw=function(f,j,k){if(this.invalidTiles.length==0){return}if(this.canvas==null){a.Logger.log(a.Logger.FINEST,"s7sdk.Resolution.draw - getting canvas this.loadTiles=%0",this.loadTiles);this.canvas=a.Util.getCanvas();this.canvas.width=this.tileWidth;this.canvas.height=this.tileHeight;a.Util.setObjPos(this.canvas,0,0);this.canvas.parentView=this.view}else{if(this.canvas.width<this.tileWidth||this.canvas.height<this.tileHeight){this.canvas.width=this.tileWidth;this.canvas.height=this.tileHeight}}var b=new a.Matrix2D(1,0,0,1,this.invalidTiles[0].pos_x*a.Enum.TILE.SIZE*-1,this.invalidTiles[0].pos_y*a.Enum.TILE.SIZE*-1);var d=0;for(var e=0;e<this.invalidTiles.length;e++){var h=this.getCreateTile(this.invalidTiles[e]);if(h.loadSent&&h.loaded==false){d++;h.image.resolutionBuffer=this;h.image.addEventListener(a.Event.TILE_LOADED,a.Resolution.onTileLoad,true)}h.draw(b,this.canvas,k)}if(k.canvas!=null&&k.canvas.getContext!=null){var m=k.canvas.getContext("2d");var c=b.clone();c.invert();c.concat(j);var g=c.clone();g.invert();var l=g.transformRect(f);var i=new a.Rectangle(0,0,this.canvas.width,this.canvas.height);l=l.intersection(i);if(this.transparent){m.clearRect(f.x,f.y,f.width,f.height)}m.drawImage(this.canvas,l.x,l.y,l.width,l.height,f.x,f.y,f.width,f.height)}if(d==0){a.Util.releaseCanvas(this.canvas);delete this.canvas.parentView;this.canvas=null;a.Logger.log(a.Logger.FINEST,"s7sdk.Resolution.draw - Releasing Canvas");this.invalidTiles=new Array()}};a.Resolution.prototype.release=function(){if(this.canvas!=null){a.Util.releaseCanvas(this.canvas);delete this.canvas.parentView;this.canvas=null;a.Logger.log(a.Logger.FINEST,"s7sdk.Resolution.release - Explicit canvas release")}};a.Resolution.prototype.invalidate=function(d,b){this.loadTiles=(b!=undefined&&b!=null)?b:0;this.invalidTiles=this.intersect(d.x,d.y,d.width,d.height);a.Logger.log(a.Logger.FINEST,"s7sdk.Resolution.invalidate - viewport: "+d.x+", "+d.y+", "+d.width+", "+d.height+"  Tiles: "+this.invalidTiles.length);for(var e=0;e<this.invalidTiles.length;e++){var c=this.getCreateTile(this.invalidTiles[e]);c.invalidate()}}}})(s7getCurrentNameSpace());